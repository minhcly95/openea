<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>OpenEA: Deploy an algorithm on a Cluster</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customdoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">OpenEA
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('tut6.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Deploy an algorithm on a Cluster </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#tut6-cluster">Cluster computation</a></li>
<li class="level1"><a href="#tut6-cli">Deploy an EAML configuration file</a><ul><li class="level2"><a href="#tut6-localcli">Local deployment</a></li>
<li class="level2"><a href="#tut6-remotecli">Remote deployment</a></li>
</ul>
</li>
<li class="level1"><a href="#tut6-exec">Deploy an Executable program</a><ul><li class="level2"><a href="#tut6-localexec">Modification</a></li>
<li class="level2"><a href="#tut6-remoteexec">Deployment</a></li>
</ul>
</li>
<li class="level1"><a href="#tut6-conclusion">Conclusion</a></li>
<li class="level1"><a href="#tut6-appendix">Appendix: Write a Cluster computable class</a></li>
</ul>
</div>
<div class="textblock"><p>This page describes how to use the distributed computation feature to deploy your algorithm on a cluster.</p>
<dl class="section user"><dt>Tutorial level</dt><dd>Intermediate</dd></dl>
<dl class="section user"><dt>Previous tutorial</dt><dd><a class="el" href="tut5.html">Bundle custom operators into a Plugin</a></dd></dl>
<h1><a class="anchor" id="tut6-cluster"></a>
Cluster computation</h1>
<p>First, for those people who don't know what a cluster is, a <b>Computer cluster</b> is just a set of connected computers. People use clusters to speed up their computation, similar to multi-threading, but at a much more greater scale. Multi-threading depends on the number of cores in your machine, but you can't increase the number of cores in your CPU easily. Sometimes, it is cheaper to buy a second machine (and a third one, and so on) with a bunch of Ethernet cables and this is when cluster computation comes in. But if you don't have a second machine (or machines), cluster computation can still benefit you, so please read until the end of this section.</p>
<p>In multi-threading, <b>threads</b> are the factor which speeds up your program. A simple program only uses a thread, and hence utilizes only a CPU core. But your computer has many cores, so more threads spawned mean more CPU cores utilized and more computation done (of course, if you only have four cores, then a fifth thread will be redundant and may slow down your program). Similarly, cluster computation spawns multiple <b>processes</b> to get things done faster, but you can spawn processes on other machines, while with threads, you can't. However, threads use shared memory to communicate while processes have their own memory space, therefore, they must communicate via another method. In this library, we use Message Passing Interface (MPI) and its implementation, the OpenMPI library, as the communication method. Basically, using MPI, processes communicate with each others via messages on TCP/IP, and messages passing takes time. If you need to parallelize something which takes only 1 ms, MPI will not speed it up, but slow it down. However, if "something" takes more than 1 second, MPI will start making your program faster.</p>
<dl class="section note"><dt>Note</dt><dd>You need to experiment to know whether cluster computation really speeds up your program. It depends on the size of data and the computational time of the parallelized part of the program. But roughly, if the parallelized part to many seconds or minutes each generation, this likely will speed it up.</dd></dl>
<p>In OpenEA, there are two types of cluster deployment: locally and remotely. Deploying a cluster locally means you just spawn multiple processes on the same machine, while remote deployment is spawning processes on another machines (may include yours also). They will behave the same, but different in deployment process. Spawning processes on the same machine doesn't require copying any files, because they are already there. Deploying a program remotely requires you to copy that program to every remote machines, and also its dependencies. Thankfully, the framework can boost up this process by automating a part of that process, but you still need to be aware of what is going on in your cluster.</p>
<p>But why do we need local cluster deployment while we can use multi-threading which is a much more efficient solution? The answer is: sometimes, your program cannot be parallelized using multi-threading. For example, your program uses an external library which manages everything using static classes, but you want to spawn multiple instances in parallel. In such example, the only way is to spawn multiple processes on the same machine and hence local cluster deployment. Now, if you think this won't benefit you in either ways: doing computation on multiple machines, or parallelizing something which cannot be done by multi-threading, you can skip this tutorial.</p>
<h1><a class="anchor" id="tut6-cli"></a>
Deploy an EAML configuration file</h1>
<p>Normally, we will start with a C++ example (<a class="el" href="tut1.html">Tutorial 1</a>, <a class="el" href="tut4.html">Tutorial 4</a>), then make it available to the CLI (<a class="el" href="tut2.html">Tutorial 2</a>, <a class="el" href="tut5.html">Tutorial 5</a>). But in this tutorial, we will do the opposite, because deploy an EAML configuration file is much more easier than the other option.</p>
<h2><a class="anchor" id="tut6-localcli"></a>
Local deployment</h2>
<p>To run an EAML file normally, as mention in <a class="el" href="tut2.html">Tutorial 2</a> and <a class="el" href="tut5.html">Tutorial 5</a>, we use this command:</p>
<div class="fragment"><div class="line">openea run &lt;eaml_file&gt; &lt;options&gt;</div></div><!-- fragment --><p>To deploy it locally, you only need to insert <code><b>cluster local</b></code> before the <code><b>run</b></code> keyword:</p>
<div class="fragment"><div class="line">openea cluster local run &lt;eaml_file&gt; &lt;options&gt;</div></div><!-- fragment --><p>You can test on the EAML file we edit in <a class="el" href="tut5.html">Tutorial 5</a>:</p>
<div class="fragment"><div class="line">openea cluster local run SphereOpt.eaml</div></div><!-- fragment --><p>The output of the run will look like this:</p>
<div class="fragment"><div class="line">[2017-06-29 09:23:05.498020] PluginLoader: Loaded 1 plugin(s).</div><div class="line">[2017-06-29 09:23:05.498062] CLI: Reading SphereOpt.eaml</div><div class="line">[2017-06-29 09:23:05.498295] CLI: <span class="stringliteral">&quot;EvolutionStrategy&quot;</span> reconstructed</div><div class="line">[2017-06-29 09:23:05.498351] CLI: BackupHook not found. Default one added to folder <span class="stringliteral">&quot;~/.openea/.backup&quot;</span>.</div><div class="line">[2017-06-29 09:23:05.518845] Cluster deployed, size = 4</div><div class="line">[2017-06-29 09:23:05.518877] Cluster Slave node #1 on bqminh-pc started</div><div class="line">[2017-06-29 09:23:05.518876] Cluster Slave node #3 on bqminh-pc started</div><div class="line">[2017-06-29 09:23:05.518883] Cluster Slave node #2 on bqminh-pc started</div><div class="line">[2017-06-29 09:23:05.518899] Parallel processing is disabled</div><div class="line">[2017-06-29 09:23:05.520112] <a class="code" href="classea_1_1_backup_hook.html#abb170210410b287564c5f7bc4c340bad">BackupHook::DoInitial</a>: Cleared 1 file(s) in &quot;~/.openea/.backup&quot;.</div><div class="line">[2017-06-29 09:23:05.520135] Population initialized, evaluation 100</div><div class="line">[2017-06-29 09:23:05.520152] Evolution started from generation 0, evaluation 100</div><div class="line">...</div><div class="line">[2017-06-29 09:24:35.796488] GenerationTerminationHook: Reached generation <span class="preprocessor">#10000 &gt;= 10000. Terminating...</span></div><div class="line">[2017-06-29 09:24:35.797089] BackupHook: Backup saved to <span class="stringliteral">&quot;~/.openea/.backup/010000.eabak&quot;</span>.</div><div class="line">[2017-06-29 09:24:35.797191] Evolution stopped at generation 10000, evaluation 1000100</div><div class="line">[2017-06-29 09:24:35.797271] Time Report: [S] 0.169562 [M] 0.00905972 [E] 1.4072 [F] 0.0960419 [Total] 1.75672 ms</div><div class="line">[2017-06-29 09:24:35.799692] Cluster Slave node #1 on bqminh-pc shut down</div><div class="line">[2017-06-29 09:24:35.799768] Cluster Slave node #3 on bqminh-pc shut down</div><div class="line">[2017-06-29 09:24:35.800616] Cluster Slave node #2 on bqminh-pc shut down</div></div><!-- fragment --><p>First of all, we can notice these line announcing that the cluster has been deployed:</p>
<div class="fragment"><div class="line">[2017-06-29 09:23:05.518845] Cluster deployed, size = 4</div><div class="line">[2017-06-29 09:23:05.518877] Cluster Slave node #1 on bqminh-pc started</div><div class="line">[2017-06-29 09:23:05.518876] Cluster Slave node #3 on bqminh-pc started</div><div class="line">[2017-06-29 09:23:05.518883] Cluster Slave node #2 on bqminh-pc started</div></div><!-- fragment --><p>Then, multi-threading is disabled, because using cluster computation disables multi-threading automatically:</p>
<div class="fragment"><div class="line">[2017-06-29 09:23:05.518899] Parallel processing is disabled</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>You can forced enable multi-threading by using <code>-p</code> option in the CLI (see <a class="el" href="tut3.html">Tutorial 3</a>).</dd></dl>
<p>Finally, you can see that the cluster has been shut down at the end of the program:</p>
<div class="fragment"><div class="line">[2017-06-29 09:24:35.799692] Cluster Slave node #1 on bqminh-pc shut down</div><div class="line">[2017-06-29 09:24:35.799768] Cluster Slave node #3 on bqminh-pc shut down</div><div class="line">[2017-06-29 09:24:35.800616] Cluster Slave node #2 on bqminh-pc shut down</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>Pressing <code>Ctrl+C</code> will terminate the CLI, but it will take time (several seconds to half minute) to shut down the cluster. This is normal behaviour, but you may get confused because the message doesn't show immediately.</dd></dl>
<h2><a class="anchor" id="tut6-remotecli"></a>
Remote deployment</h2>
<p>Before you can deploy a cluster remotely, you must configure the CLI so it knows which machines are in the cluster. You only need to do this once by editing a file named <code><b>cluster.conf</b></code> which can be accessed directly using the command:</p>
<div class="fragment"><div class="line">openea edit cluster</div></div><!-- fragment --><p>The content of the file should be similar to the following example:</p>
<div class="fragment"><div class="line">localhost             <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/algorithm/max.html">max</a>-slots=4</div><div class="line">user1@192.168.0.101   <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/algorithm/max.html">max</a>-slots=4</div><div class="line">user2@192.168.0.102   <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/algorithm/max.html">max</a>-slots=5</div><div class="line">user3@192.168.0.103   <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/algorithm/max.html">max</a>-slots=8</div></div><!-- fragment --><p>Where <code>user1</code>, <code>user2</code>, <code>user3</code> are the user name on each machine. <code>max-slots</code> indicates the maximum number of processes that you can spawned on each machine. You can edit the file <code><b>/etc/hosts</b></code> to give your machines a readable name but that is not required. However, it is required to have <code>localhost</code> as the first machine in the file. You want the first process to be on your machine, otherwise back-up files and other stuff won't be saved on that machine. Save the cluster configuration file and use this command to launch the program remotely.</p>
<div class="fragment"><div class="line">openea cluster remote run &lt;eaml_file&gt; &lt;options&gt;</div></div><!-- fragment --><p>For example:</p>
<div class="fragment"><div class="line">openea cluster remote run SphereOpt.eaml</div></div><!-- fragment --><p>It will automate (a part) of the copying process for you:</p>
<div class="fragment"><div class="line">Copying CLI and plugins to localhost...</div><div class="line"></div><div class="line">openea-run                                                100%  174KB 174.2KB/s   00:00</div><div class="line">libopenea.so                                              100%  224KB 224.3KB/s   00:00</div><div class="line">libopenea_addon.so                                        100%  224KB 224.3KB/s   00:00</div><div class="line">plugin-remote.conf                                        100%   12     0.0KB/s   00:00</div><div class="line">SphereOpt.eaml                                            100%  692     0.7KB/s   00:00</div><div class="line">libopenea_SO.so                                           100%  181KB 180.6KB/s   00:00</div><div class="line">remotelaunch.sh                                           100%  436     0.4KB/s   00:00</div><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line">Launching...</div></div><!-- fragment --><p>What the framework will copy for you:</p><ul>
<li>The EAML file itself</li>
<li>The <code><b>"openea run"</b></code> executable</li>
<li>The core library</li>
<li>The add-on library</li>
<li>The modified <code>plugin.conf</code> file</li>
<li>All plugins found in <code>plugin.conf</code></li>
<li>A shell script used to launch on remote machines</li>
</ul>
<p>If your plugins depend on other external libraries, you must install those libraries in all remote machines (via <code><b>apt-get</b></code> or other ways). Another method is to copy the binary files of the libraries by yourself. The framework provides you a convinient way to copy any file or folder to all configured remote machines. To copy a file or folder, use this command:</p>
<div class="fragment"><div class="line">openea cluster remote populate &lt;file_name&gt;</div></div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd>It is partly your responsibility to ensure all dependencies are installed in all remote machines. The framework can automate this process but it cannot cover all your requirements.</dd></dl>
<h1><a class="anchor" id="tut6-exec"></a>
Deploy an Executable program</h1>
<h2><a class="anchor" id="tut6-localexec"></a>
Modification</h2>
<p>Using the CLI and EAML configuration file, any operator which is able ro be parallelized on cluster will be automically deployed. However, if you want to write a C++ style program, you must add the operator manually. In this tutorial, we will modify the <a class="el" href="_sphere_opt_8cpp.html">SphereOpt.cpp</a> program in <a class="el" href="tut4.html">Tutorial 4</a> to make it work with cluster compuation. We need to modify the main function as follow:</p>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">    <a class="code" href="namespaceea.html#a5061ad2f4477daa266985d7cd0f7f1c6">EvolutionStrategyPtr</a> strategy = make_shared&lt;EvolutionStrategy&gt;(POP_SIZE);</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    <span class="keyword">auto</span> evaluator = strategy-&gt;evaluator.Create&lt;TypedFunctionalEvaluator&lt;DoubleArrayGenome&gt;&gt;( [] (<span class="keyword">const</span> <a class="code" href="namespaceea.html#a28f6c7da694dbd57413b188e0fb3cb33">DoubleArrayGenomePtr</a>&amp; genome) {</div><div class="line">        ...</div><div class="line">    });</div><div class="line"></div><div class="line">    ...</div><div class="line"></div><div class="line">    <a class="code" href="classea_1_1_cluster.html#ae2124dfb02f922edc216d54d194dfa3e">Cluster::AddOperator</a>(evaluator);</div><div class="line"></div><div class="line">    <a class="code" href="namespaceea.html#af551c7bd55451130c5d94f3371c263b1">SessionPtr</a> session = strategy-&gt;Evolve();</div><div class="line"></div><div class="line">    <a class="code" href="classea_1_1_cluster.html#a8eee3f84fe88ced21b09a684ded2c1d2">Cluster::Destroy</a>();</div><div class="line"></div><div class="line">    <span class="keywordflow">return</span> 0;</div><div class="line">}</div></div><!-- fragment --><p>First, we catch to returned object from <code>strategy-&gt;evaluator.Create()</code> to get an <a class="el" href="classea_1_1_individual_evaluator.html" title="The interface for evaluation method at individual level. ">IndividualEvaluator</a> object (<code>auto</code> is just a keyword to deduce the type automatically). Then, right before <code>strategy-&gt;Evolve()</code>, you call <a class="el" href="classea_1_1_cluster.html#ae2124dfb02f922edc216d54d194dfa3e" title="Add an operator to the cluster. ">Cluster::AddOperator()</a> to add the <a class="el" href="classea_1_1_individual_evaluator.html" title="The interface for evaluation method at individual level. ">IndividualEvaluator</a> object. Finally, call <a class="el" href="classea_1_1_cluster.html#a8eee3f84fe88ced21b09a684ded2c1d2" title="Destroy the cluster. ">Cluster::Destroy()</a> to shut down the cluster properly. Recompile it just like in <a class="el" href="tut4.html">Tutorial 4</a> and we are ready to deploy the executable.</p>
<dl class="section note"><dt>Note</dt><dd>You cannot add anything to the <a class="el" href="classea_1_1_cluster.html" title="Static class providing cluster computation feature. ">Cluster</a> using <a class="el" href="classea_1_1_cluster.html#ae2124dfb02f922edc216d54d194dfa3e" title="Add an operator to the cluster. ">Cluster::AddOperator()</a>, only classes derived from <a class="el" href="classea_1_1_cluster_computable.html" title="The interface for operators which are computable on cluster. ">ClusterComputable</a> can be added (e.g. <a class="el" href="classea_1_1_individual_evaluator.html" title="The interface for evaluation method at individual level. ">IndividualEvaluator</a> and its children). See <a class="el" href="tut6.html#tut6-appendix">Appendix: Write a Cluster computable class</a> to know how to write such a class.</dd>
<dd>
However, you can have multiple operators deployed in your cluster by calling <a class="el" href="classea_1_1_cluster.html#ae2124dfb02f922edc216d54d194dfa3e" title="Add an operator to the cluster. ">Cluster::AddOperator()</a> multiple times (before <a class="el" href="classea_1_1_strategy.html#a79aeeb32f547061867ca6ee90a1f560b" title="Use this Strategy to evolve the given Population. ">Strategy::Evolve()</a>). That's why the function name is <code>"AddOperator"</code>, not <code>"SetOperator"</code>.</dd></dl>
<h2><a class="anchor" id="tut6-remoteexec"></a>
Deployment</h2>
<p>The deployment is exectly the same with EAML file deployment, but this time, change the keyword <code><b>"run"</b></code> into <code><b>"exec"</b></code>. For example, to deploy the above executable locally, use:</p>
<div class="fragment"><div class="line">openea cluster local exec SphereOpt</div></div><!-- fragment --><p>And for remote deployment, use this command:</p>
<div class="fragment"><div class="line">openea cluster remote exec SphereOpt</div></div><!-- fragment --><p>The same warning about dependencies is also applied here.</p>
<h1><a class="anchor" id="tut6-conclusion"></a>
Conclusion</h1>
<p>In this tutorial, you have learned how to deploy your program in either form: EAML configuration file with plugins, and executable file compiled from C++. In short, you can deploy a program by using the command:</p>
<div class="fragment"><div class="line">openea cluster local|remote run|exec</div></div><!-- fragment --><p>In the case of remote deployment, you must:</p><ul>
<li>Configure the cluster using <code><b>openea edit cluster</b></code>.</li>
<li>Make sure all dependencies are installed on remote machines.</li>
</ul>
<p>In the case of deployment of executable file, you must:</p><ul>
<li>Add the operators you want to deploy using <a class="el" href="classea_1_1_cluster.html#ae2124dfb02f922edc216d54d194dfa3e" title="Add an operator to the cluster. ">Cluster::AddOperator()</a>.</li>
<li>Call <a class="el" href="classea_1_1_cluster.html#a8eee3f84fe88ced21b09a684ded2c1d2" title="Destroy the cluster. ">Cluster::Destroy()</a> to shut down the cluster properly.</li>
</ul>
<dl class="section note"><dt>Note</dt><dd>More tutorials are coming!</dd></dl>
<h1><a class="anchor" id="tut6-appendix"></a>
Appendix: Write a Cluster computable class</h1>
<p>This section shows you how to write a simple custom <a class="el" href="classea_1_1_cluster_computable.html" title="The interface for operators which are computable on cluster. ">ClusterComputable</a> class calculating, e.g., the square of a double number. You can consult the API documentation of <a class="el" href="classea_1_1_cluster_computable.html" title="The interface for operators which are computable on cluster. ">ClusterComputable</a> class to know the signature of its functions.</p>
<p><a class="el" href="classea_1_1_cluster_computable.html" title="The interface for operators which are computable on cluster. ">ClusterComputable</a> is a template class which requires two types: input type <code><b>InputT</b></code> and output type <code><b>OutputT</b></code>. In this example (calculating the square of a number), <code>InputT</code> and <code>OutputT</code> would be both <code>double</code> type, so we will derive our class (e.g. <code>SquareCalculator</code>) from <code>ClusterComputable&lt;double, double&gt;</code>:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;openea/misc/ClusterComputableImpl.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span>std;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceea.html">ea</a>;</div><div class="line"></div><div class="line"><span class="keyword">class </span>SquareCalculator : <span class="keyword">public</span> <a class="code" href="classea_1_1_cluster_computable.html">ClusterComputable</a>&lt;double, double&gt; {</div><div class="line">    ...</div><div class="line">}</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>You need to include the file <code><b>&lt;openea/misc/ClusterComputableImpl.h&gt;</b></code> explicitly. This file is not included in <code>&lt;openea/EA.h&gt;</code> to speed up the compile time in normal case.</dd></dl>
<p>Then you need to override the method <a class="el" href="classea_1_1_cluster_computable.html#a2a3c03f9670ad4e5c2d99fc4efd4ea4e" title="The segment of code to be processed remotely. ">ClusterComputable::ProcessOnRemote()</a>. This is the segment of code which will be run on remote processes. Here you implement the calculation:</p>
<div class="fragment"><div class="line"><span class="keyword">virtual</span> <span class="keywordtype">double</span> ProcessOnRemote(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp; pInput)<span class="keyword"> override </span>{</div><div class="line">    <span class="keywordflow">return</span> pInput * pInput;</div><div class="line">}</div></div><!-- fragment --><dl class="section warning"><dt>Warning</dt><dd>The <code>InputT</code> and <code>OutputT</code> must satisfy the <a class="el" href="classea_1_1_binary_serializer.html" title="Static class provide serialize and de-serialize method in binary form. ">BinarySerializer</a> condition (that means it can be (de)serialized by <a class="el" href="classea_1_1_binary_serializer.html" title="Static class provide serialize and de-serialize method in binary form. ">BinarySerializer</a>). Primary types, string, simple structs/classes, <a class="elRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector.html">std::vector</a>, <a class="elRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/map.html">std::map</a> and <a class="elRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/memory/shared_ptr.html">std::shared_ptr</a> of <a class="el" href="classea_1_1_storable.html" title="Base class for classes which can be stored in binary form. ">Storable</a> (and its children) are supported by default. In this case, <code>double</code> is primary type so it is supported. Otherwise, you must implement a specialization of <a class="el" href="classea_1_1_binary_serializer.html" title="Static class provide serialize and de-serialize method in binary form. ">BinarySerializer</a> for your type. See <a class="el" href="classea_1_1_binary_serializer.html" title="Static class provide serialize and de-serialize method in binary form. ">BinarySerializer</a> for details.</dd></dl>
<p>Finally, create a function which call the method <a class="el" href="classea_1_1_cluster_computable.html#a99637d492be0d913774b2d60d7aba45f" title="Apply ProcessOnRemote() on a list of data of type InputT. ">ClusterComputable::ExecuteInCluster()</a>:</p>
<div class="fragment"><div class="line">vector&lt;double&gt; Calculate(<span class="keyword">const</span> vector&lt;double&gt;&amp; pInputArray) {</div><div class="line">    <span class="keywordflow">return</span> ExecuteInCluster(pInputArray);</div><div class="line">}</div></div><!-- fragment --><p>This is where cluster computation comes in. The function <a class="el" href="classea_1_1_cluster_computable.html#a99637d492be0d913774b2d60d7aba45f" title="Apply ProcessOnRemote() on a list of data of type InputT. ">ClusterComputable::ExecuteInCluster()</a> will distribute your input vector to worker processes (slave nodes). Then it aggregates all the output from those processes to produce a vector of the same size. Each entry in the output vector is corresponding to the input vector at the same position. Here is the full code that you can test with:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;openea/EA.h&gt;</span></div><div class="line"><span class="preprocessor">#include &lt;openea/misc/ClusterComputableImpl.h&gt;</span></div><div class="line"></div><div class="line"><span class="keyword">using namespace </span>std;</div><div class="line"><span class="keyword">using namespace </span><a class="code" href="namespaceea.html">ea</a>;</div><div class="line"></div><div class="line"><span class="keyword">class </span>SquareCalculator : <span class="keyword">public</span> <a class="code" href="classea_1_1_cluster_computable.html">ClusterComputable</a>&lt;double, double&gt; {</div><div class="line"><span class="keyword">public</span>:</div><div class="line">    <span class="keyword">virtual</span> <span class="keywordtype">double</span> ProcessOnRemote(<span class="keyword">const</span> <span class="keywordtype">double</span>&amp; pInput)<span class="keyword"> override </span>{</div><div class="line">        <span class="keywordflow">return</span> pInput * pInput;</div><div class="line">    }</div><div class="line">    <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector.html">vector&lt;double&gt;</a> Calculate(<span class="keyword">const</span> <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector.html">vector&lt;double&gt;</a>&amp; pInputArray) {</div><div class="line">        <span class="keywordflow">return</span> ExecuteInCluster(pInputArray);</div><div class="line">    }</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keywordtype">int</span> main() {</div><div class="line">    <span class="keyword">auto</span> sqrCalc = make_shared&lt;SquareCalculator&gt;();</div><div class="line"></div><div class="line">    <a class="code" href="classea_1_1_cluster.html#ae2124dfb02f922edc216d54d194dfa3e">Cluster::AddOperator</a>(sqrCalc);</div><div class="line"></div><div class="line">    <a class="code" href="classea_1_1_cluster.html#a62baf24be337ee36dcfdd10597ff0c64">Cluster::Deploy</a>();</div><div class="line"></div><div class="line">    <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector.html">vector&lt;double&gt;</a> input = {1, 2, 3, 4, 5};</div><div class="line">    <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/container/vector.html">vector&lt;double&gt;</a> result = sqrCalc-&gt;Calculate(input);</div><div class="line"></div><div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">double</span> number: result)</div><div class="line">        <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/io/basic_ostream.html">cout</a> &lt;&lt; number &lt;&lt; <a class="codeRef" doxygen="/home/minh/repo/vgu_interns/EA/doc/cppreference-doxygen-web.tag.xml:http://en.cppreference.com/w/" href="http://en.cppreference.com/w/cpp/io/manip/endl.html">endl</a>;</div><div class="line"></div><div class="line">    <a class="code" href="classea_1_1_cluster.html#a8eee3f84fe88ced21b09a684ded2c1d2">Cluster::Destroy</a>();</div><div class="line">}</div></div><!-- fragment --><p>However, you must compile it with <code><b>mpic++</b></code> instead of <code>g++</code>:</p>
<div class="fragment"><div class="line">mpic++ --std=c++14 -o SquareCalculator SquareCalculator.cpp -lopenea</div></div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>You only need to compile a source file with <code>mpic++</code> if it contains the function <a class="el" href="classea_1_1_cluster_computable.html#a99637d492be0d913774b2d60d7aba45f" title="Apply ProcessOnRemote() on a list of data of type InputT. ">ClusterComputable::ExecuteInCluster()</a> directly. For other files, you can compile them normally.</dd></dl>
<p>Execute the generated executable using the command:</p>
<div class="fragment"><div class="line">openea cluster local exec SquareCalculator</div><div class="line">or</div><div class="line">openea cluster remote exec SquareCalculator</div></div><!-- fragment --><p>The output of the program may look like:</p>
<div class="fragment"><div class="line">[2017-06-29 14:05:36.051314] Cluster deployed, size = 4</div><div class="line">[2017-06-29 14:05:36.051341] Cluster Slave node #1 on bqminh-pc started</div><div class="line">[2017-06-29 14:05:36.051341] Cluster Slave node #3 on bqminh-pc started</div><div class="line">[2017-06-29 14:05:36.051350] Cluster Slave node #2 on bqminh-pc started</div><div class="line">1</div><div class="line">4</div><div class="line">9</div><div class="line">16</div><div class="line">25</div><div class="line">[2017-06-29 14:05:36.053921] Cluster Slave node #2 on bqminh-pc shut down</div><div class="line">[2017-06-29 14:05:36.054050] Cluster Slave node #3 on bqminh-pc shut down</div><div class="line">[2017-06-29 14:05:36.055229] Cluster Slave node #1 on bqminh-pc shut down</div></div><!-- fragment --><p>It shows that we have successfully calculated the square of 5 numbers using cluster computation. Next, you could try experimenting this example with more data or implementing another class by yourself. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="tutorials.html">Tutorials</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
